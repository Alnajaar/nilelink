(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[175],{803:function(){},3523:function(e,t,n){"use strict";n.d(t,{POSProvider:function(){return v},F:function(){return _}});var i,a,r,s,c=n(7437),o=n(2265),E=n(4147),d=n(1418);class l{async createEvent(e,t,n){let i=Date.now(),a={id:(0,E.Z)(),type:e,timestamp:i,deviceId:this.deviceId,actorId:t,branchId:this.branchId,hash:"",previousHash:this.lastEventHash,offline:!navigator.onLine,version:1,payload:n};return a.hash=await this.calculateEventHash(a),this.lastEventHash=a.hash,a}async calculateEventHash(e){let t=JSON.stringify({id:e.id,type:e.type,timestamp:e.timestamp,deviceId:e.deviceId,actorId:e.actorId,branchId:e.branchId,previousHash:e.previousHash,payload:e.payload}),n=new TextEncoder().encode(t);return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",n))).map(e=>e.toString(16).padStart(2,"0")).join("")}async verifyEvent(e){return await this.calculateEventHash(e)===e.hash}async verifyEventChain(e){if(0===e.length)return!0;if(null!==e[0].previousHash)return console.error("First event should have null previousHash"),!1;for(let t=0;t<e.length;t++){let n=e[t];if(!await this.verifyEvent(n))return console.error("Event ".concat(n.id," has invalid hash")),!1;if(t>0){let i=e[t-1];if(n.previousHash!==i.hash)return console.error("Event ".concat(n.id," has broken chain link")),!1}}return!0}setLastEventHash(e){this.lastEventHash=e}getChainState(){return{deviceId:this.deviceId,branchId:this.branchId,lastHash:this.lastEventHash}}constructor(e,t){this.lastEventHash=null,this.deviceId=e,this.branchId=t}}var u=n(919),h=n.n(u);class T{async initialize(){try{let e=await h()({locateFile:e=>"https://sql.js.org/dist/".concat(e)}),t=localStorage.getItem("nilelink_ledger");if(t){let n=Uint8Array.from(atob(t),e=>e.charCodeAt(0));this.db=new e.Database(n)}else this.db=new e.Database,this.createTables();console.log("✅ Local Ledger initialized")}catch(e){throw console.error("❌ Failed to initialize Local Ledger:",e),e}}createTables(){this.db&&(this.db.run("\n      CREATE TABLE events (\n        id TEXT PRIMARY KEY,\n        type TEXT NOT NULL,\n        timestamp INTEGER NOT NULL,\n        deviceId TEXT NOT NULL,\n        actorId TEXT NOT NULL,\n        branchId TEXT NOT NULL,\n        hash TEXT NOT NULL UNIQUE,\n        previousHash TEXT,\n        offline INTEGER NOT NULL,\n        syncedAt INTEGER,\n        version INTEGER NOT NULL,\n        payload TEXT NOT NULL,\n        createdAt INTEGER DEFAULT (strftime('%s', 'now') * 1000)\n      )\n    "),this.db.run("CREATE INDEX idx_events_type ON events(type)"),this.db.run("CREATE INDEX idx_events_timestamp ON events(timestamp)"),this.db.run("CREATE INDEX idx_events_actor ON events(actorId)"),this.db.run("CREATE INDEX idx_events_synced ON events(syncedAt)"),this.db.run("CREATE INDEX idx_events_device ON events(deviceId)"),this.db.run("\n      CREATE TABLE metadata (\n        key TEXT PRIMARY KEY,\n        value TEXT NOT NULL,\n        updatedAt INTEGER DEFAULT (strftime('%s', 'now') * 1000)\n      )\n    "),this.db.run("\n      CREATE TABLE journal_entries (\n        id TEXT PRIMARY KEY,\n        date INTEGER NOT NULL,\n        referenceId TEXT NOT NULL,\n        description TEXT NOT NULL,\n        postedBy TEXT NOT NULL,\n        branchId TEXT NOT NULL,\n        lines TEXT NOT NULL, -- JSON array of JournalLine\n        createdAt INTEGER DEFAULT (strftime('%s', 'now') * 1000)\n      )\n    "),this.db.run("\n      CREATE TABLE staff_reputation (\n        staffId TEXT PRIMARY KEY,\n        name TEXT NOT NULL,\n        salesCount INTEGER DEFAULT 0,\n        voidCount INTEGER DEFAULT 0,\n        cashVarianceTotal REAL DEFAULT 0,\n        reliabilityScore REAL DEFAULT 100,\n        lastUpdated INTEGER NOT NULL\n      )\n    "),this.db.run("\n      CREATE TABLE demand_forecasts (\n        dateKey TEXT PRIMARY KEY, -- YYYY-MM-DD\n        predictedRevenue REAL NOT NULL,\n        predictedItems TEXT NOT NULL, -- JSON map of item -> qty\n        confidenceScore REAL NOT NULL,\n        generatedAt INTEGER NOT NULL\n      )\n    "),this.persist())}async ensureInitialized(){this.initPromise&&await this.initPromise}async insertEvent(e){if(await this.ensureInitialized(),!this.db)throw Error("Database not initialized");try{this.db.run("INSERT INTO events (\n          id, type, timestamp, deviceId, actorId, branchId,\n          hash, previousHash, offline, syncedAt, version, payload\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",[e.id,e.type,e.timestamp,e.deviceId,e.actorId,e.branchId,e.hash,e.previousHash,e.offline?1:0,e.syncedAt||null,e.version,JSON.stringify(e.payload)]),this.persist()}catch(e){throw console.error("Failed to insert event:",e),e}}async getAllEvents(){if(await this.ensureInitialized(),!this.db)return[];let e=this.db.prepare("SELECT * FROM events ORDER BY timestamp ASC"),t=[];for(;e.step();){let n=e.getAsObject();t.push(this.rowToEvent(n))}return e.free(),t}async getUnsyncedEvents(){if(await this.ensureInitialized(),!this.db)return[];let e=this.db.prepare("SELECT * FROM events WHERE syncedAt IS NULL ORDER BY timestamp ASC"),t=[];for(;e.step();){let n=e.getAsObject();t.push(this.rowToEvent(n))}return e.free(),t}async markEventSynced(e,t){await this.ensureInitialized(),this.db&&(this.db.run("UPDATE events SET syncedAt = ? WHERE id = ?",[t,e]),this.persist())}async getEventsByType(e){if(await this.ensureInitialized(),!this.db)return[];let t=this.db.prepare("SELECT * FROM events WHERE type = ? ORDER BY timestamp ASC",[e]),n=[];for(;t.step();){let e=t.getAsObject();n.push(this.rowToEvent(e))}return t.free(),n}async getEventsByTimeRange(e,t){if(await this.ensureInitialized(),!this.db)return[];let n=this.db.prepare("SELECT * FROM events WHERE timestamp >= ? AND timestamp <= ? ORDER BY timestamp ASC",[e,t]),i=[];for(;n.step();){let e=n.getAsObject();i.push(this.rowToEvent(e))}return n.free(),i}async getLastEventHash(){if(await this.ensureInitialized(),!this.db)return null;let e=this.db.prepare("SELECT hash FROM events ORDER BY timestamp DESC LIMIT 1");if(e.step()){let t=e.getAsObject().hash;return e.free(),t}return e.free(),null}async getEventCount(){if(await this.ensureInitialized(),!this.db)return 0;let e=this.db.prepare("SELECT COUNT(*) as count FROM events");e.step();let t=e.getAsObject().count;return e.free(),t}rowToEvent(e){return{id:e.id,type:e.type,timestamp:e.timestamp,deviceId:e.deviceId,actorId:e.actorId,branchId:e.branchId,hash:e.hash,previousHash:e.previousHash,offline:1===e.offline,syncedAt:e.syncedAt||void 0,version:e.version,payload:JSON.parse(e.payload)}}persist(){if(this.db)try{let e=this.db.export(),t=btoa(String.fromCharCode(...e));localStorage.setItem("nilelink_ledger",t)}catch(e){console.error("Failed to persist ledger:",e)}}async clear(){await this.ensureInitialized(),this.db&&(this.db.run("DELETE FROM events"),this.db.run("DELETE FROM metadata"),this.persist())}async exportToJSON(){return JSON.stringify(await this.getAllEvents(),null,2)}async getStats(){if(await this.ensureInitialized(),!this.db)return{totalEvents:0,unsyncedEvents:0,databaseSize:"0 KB",oldestEvent:null,newestEvent:null};let e=await this.getEventCount(),t=(await this.getUnsyncedEvents()).length,n=this.db.prepare("SELECT page_count * page_size as size FROM pragma_page_count(), pragma_page_size()");n.step();let i=n.getAsObject().size||0;n.free();let a=this.db.prepare("SELECT MIN(timestamp) as oldest, MAX(timestamp) as newest FROM events");a.step();let r=a.getAsObject(),s=r.oldest||null,c=r.newest||null;return a.free(),{totalEvents:e,unsyncedEvents:t,databaseSize:"".concat((i/1024).toFixed(2)," KB"),oldestEvent:s,newestEvent:c}}async insertJournalEntry(e){await this.ensureInitialized(),this.db&&(this.db.run("INSERT INTO journal_entries (id, date, referenceId, description, postedBy, branchId, lines) VALUES (?, ?, ?, ?, ?, ?, ?)",[e.id,e.date,e.referenceId,e.description,e.postedBy,e.branchId,JSON.stringify(e.lines)]),this.persist())}async getJournalEntries(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;if(await this.ensureInitialized(),!this.db)return[];let t=this.db.prepare("SELECT * FROM journal_entries ORDER BY date DESC LIMIT ?",[e]),n=[];for(;t.step();){let e=t.getAsObject();n.push({...e,lines:JSON.parse(e.lines)})}return t.free(),n}async updateStaffReputation(e,t,n){if(await this.ensureInitialized(),!this.db)return;let i=this.db.prepare("SELECT * FROM staff_reputation WHERE staffId = ?",[e]);if(i.step()){let t=i.getAsObject(),a=t.salesCount+(n.salesCount||0),r=t.voidCount+(n.voidCount||0),s=t.cashVarianceTotal+(n.cashVariance||0),c=100+a/10-5*r-Math.abs(s)/10;c=Math.min(100,Math.max(0,c)),this.db.run("UPDATE staff_reputation SET salesCount=?, voidCount=?, cashVarianceTotal=?, reliabilityScore=?, lastUpdated=? WHERE staffId=?",[a,r,s,c,Date.now(),e])}else this.db.run("INSERT INTO staff_reputation (staffId, name, salesCount, voidCount, cashVarianceTotal, reliabilityScore, lastUpdated) VALUES (?, ?, ?, ?, ?, ?, ?)",[e,t,n.salesCount||0,n.voidCount||0,n.cashVariance||0,100,Date.now()]);i.free(),this.persist()}async getStaffReputation(e){if(await this.ensureInitialized(),!this.db)return null;let t=this.db.prepare("SELECT * FROM staff_reputation WHERE staffId = ?",[e]),n=t.step()?t.getAsObject():null;return t.free(),n}async getAllStaffReputation(){if(await this.ensureInitialized(),!this.db)return[];let e=this.db.prepare("SELECT * FROM staff_reputation ORDER BY reliabilityScore DESC"),t=[];for(;e.step();)t.push(e.getAsObject());return e.free(),t}async saveForecast(e){await this.ensureInitialized(),this.db&&(this.db.run("INSERT OR REPLACE INTO demand_forecasts (dateKey, predictedRevenue, predictedItems, confidenceScore, generatedAt) VALUES (?, ?, ?, ?, ?)",[e.dateKey,e.predictedRevenue,JSON.stringify(e.predictedItems),e.confidenceScore,Date.now()]),this.persist())}async getForecast(e){if(await this.ensureInitialized(),!this.db)return null;let t=this.db.prepare("SELECT * FROM demand_forecasts WHERE dateKey = ?",[e]);if(t.step()){let e=t.getAsObject();return t.free(),{...e,predictedItems:JSON.parse(e.predictedItems)}}return t.free(),null}constructor(){this.db=null,this.initPromise=null,this.initPromise=this.initialize()}}class I{start(){console.log("\uD83D\uDD04 Sync Worker started"),this.syncNow(),this.intervalId=setInterval(()=>{this.syncNow()},this.syncInterval),window.addEventListener("online",()=>{console.log("\uD83C\uDF10 Connection restored, syncing..."),this.syncNow()}),window.addEventListener("offline",()=>{console.log("\uD83D\uDCE1 Connection lost, entering offline mode")})}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),console.log("⏸️  Sync Worker stopped")}async syncNow(){if(this.isSyncing)return{success:!1,syncedCount:0,error:"Sync already in progress"};if(!navigator.onLine)return{success:!1,syncedCount:0,error:"No internet connection"};this.isSyncing=!0;try{let e=await this.ledger.getUnsyncedEvents();if(0===e.length)return this.isSyncing=!1,{success:!0,syncedCount:0};console.log("\uD83D\uDCE4 Syncing ".concat(e.length," events..."));let t=await fetch("".concat(this.apiEndpoint,"/events/batch"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:e})});if(!t.ok)throw Error("Sync failed: ".concat(t.statusText));await t.json();let n=Date.now();for(let t of e)await this.ledger.markEventSynced(t.id,n);return console.log("✅ Synced ".concat(e.length," events")),this.isSyncing=!1,{success:!0,syncedCount:e.length}}catch(e){return console.error("❌ Sync error:",e),this.isSyncing=!1,{success:!1,syncedCount:0,error:e instanceof Error?e.message:"Unknown error"}}}async getSyncStatus(){let e=await this.ledger.getUnsyncedEvents();return{isOnline:navigator.onLine,isSyncing:this.isSyncing,unsyncedCount:e.length}}constructor(e,t){this.syncInterval=3e4,this.intervalId=null,this.isSyncing=!1,this.ledger=e,this.apiEndpoint=t}}class S{setRecipe(e){e.costPerServing=this.calculateRecipeCost(e),this.recipes.set(e.menuItemId,e)}getRecipe(e,t){var n;let i=this.recipes.get(e);return i?t&&(null===(n=i.branchVariants)||void 0===n?void 0:n[t])?{...i,ingredients:i.branchVariants[t]}:i:null}calculateRecipeCost(e){let t=0;for(let n of e.ingredients)t+=n.quantity*n.costPerUnit;return e.yield>0?t/e.yield:0}deductForSale(e,t,n){let i=this.getRecipe(e,n);if(!i)throw Error("Recipe not found for menu item: ".concat(e));let a=[];for(let e of i.ingredients){let n=this.inventory.get(e.ingredientId);if(!n){console.warn("Ingredient ".concat(e.ingredientName," not in inventory"));continue}let i=e.quantity*t;n.currentStock<i&&console.warn("Insufficient stock for ".concat(e.ingredientName,". ")+"Required: ".concat(i,", Available: ").concat(n.currentStock)),n.currentStock-=i,a.push({ingredientId:e.ingredientId,ingredientName:e.ingredientName,deducted:i,unit:e.unit,remainingStock:n.currentStock})}return a}canFulfillRecipe(e,t,n){let i=this.getRecipe(e,n);if(!i)return{canFulfill:!1,missingIngredients:[]};let a=[];for(let e of i.ingredients){let n=this.inventory.get(e.ingredientId),i=e.quantity*t,r=(null==n?void 0:n.currentStock)||0;r<i&&a.push({ingredientName:e.ingredientName,required:i,available:r,unit:e.unit})}return{canFulfill:0===a.length,missingIngredients:a}}updateInventory(e){this.inventory.set(e.ingredientId,e)}getReorderList(){let e=[];for(let[,t]of this.inventory)t.currentStock<=t.reorderLevel&&e.push(t);return e.sort((e,t)=>e.currentStock-t.currentStock)}calculateVariance(e,t,n){let i=this.inventory.get(e);if(!i)throw Error("Ingredient ".concat(e," not found in inventory"));let a=i.currentStock-t-n,r=t>0?a/t*100:0,s="normal";return Math.abs(r)>20?s="critical-variance":Math.abs(r)>10&&(s="high-variance"),{ingredientId:e,expectedUsage:t,actualStock:n,variance:a,variancePercent:r,status:s}}calculateProfitMargin(e,t,n){let i=this.getRecipe(e,n);if(!i)return{cost:0,price:t,profit:t,marginPercent:100};let a=i.costPerServing,r=t-a;return{cost:a,price:t,profit:r,marginPercent:t>0?r/t*100:0}}getAllRecipes(){return Array.from(this.recipes.values())}getAllInventory(){return Array.from(this.inventory.values())}seed(){[{ingredientId:"ing-1",ingredientName:"Beef Patty",currentStock:100,unit:"pcs",reorderLevel:20,costPerUnit:2.5},{ingredientId:"ing-2",ingredientName:"Bun",currentStock:100,unit:"pcs",reorderLevel:20,costPerUnit:.5},{ingredientId:"ing-3",ingredientName:"Potatoes",currentStock:50,unit:"kg",reorderLevel:10,costPerUnit:1.2},{ingredientId:"ing-4",ingredientName:"Truffle Oil",currentStock:5,unit:"L",reorderLevel:1,costPerUnit:45},{ingredientId:"ing-5",ingredientName:"Pizza Dough",currentStock:40,unit:"pcs",reorderLevel:10,costPerUnit:1.5},{ingredientId:"ing-6",ingredientName:"Coffee Beans",currentStock:10,unit:"kg",reorderLevel:2,costPerUnit:18}].forEach(e=>this.inventory.set(e.ingredientId,e)),this.setRecipe({id:"rec-1",menuItemId:"1",menuItemName:"Burger Classic",ingredients:[{ingredientId:"ing-1",ingredientName:"Beef Patty",quantity:1,unit:"pcs",costPerUnit:2.5},{ingredientId:"ing-2",ingredientName:"Bun",quantity:1,unit:"pcs",costPerUnit:.5}],yield:1,costPerServing:3,prepTime:10,createdAt:Date.now(),updatedAt:Date.now()}),this.setRecipe({id:"rec-2",menuItemId:"2",menuItemName:"Truffle Fries",ingredients:[{ingredientId:"ing-3",ingredientName:"Potatoes",quantity:.3,unit:"kg",costPerUnit:1.2},{ingredientId:"ing-4",ingredientName:"Truffle Oil",quantity:.01,unit:"L",costPerUnit:45}],yield:1,costPerServing:.81,prepTime:5,createdAt:Date.now(),updatedAt:Date.now()})}constructor(){this.recipes=new Map,this.inventory=new Map}}class R{async recordCashSale(e,t,n,i,a){let r=a-t;await this.eventEngine.createEvent(d.t.PAYMENT_COLLECTED_CASH,i,{orderId:e,amount:t,currency:n,amountTendered:a,changeGiven:r,cashierId:i}),this.updateStaffBalance(i,t,n)}async handoverCash(e,t,n,i,a,r,s){let c=s-r,o=await this.eventEngine.createEvent(d.t.CASH_HANDOVER,n,{amount:s,currency:t,fromStaffId:n,toStaffId:i,reason:a,expectedAmount:r,actualAmount:s,variance:c});return this.updateStaffBalance(n,-s,t),this.updateStaffBalance(i,s,t),o}async reconcileShift(e,t,n,i,a){let r=i.reduce((e,t)=>e+t.total,0),s=r-n,c=n>0?s/n*100:0,o="balanced";s>.01?o="over":s<-.01&&(o="short");let E={shiftId:e,staffId:t,expectedBalance:n,actualBalance:r,variance:s,variancePercent:c,denominationBreakdown:i,timestamp:Date.now(),status:o,notes:a};return await this.eventEngine.createEvent(d.t.CASH_RECONCILIATION,t,{shiftId:e,staffId:t,expectedBalance:n,actualBalance:r,variance:s,denominationBreakdown:i,notes:a}),this.resetStaffBalance(t),E}async openDrawer(e,t,n){await this.eventEngine.createEvent(d.t.CASH_DRAWER_OPENED,e,{staffId:e,openingBalance:t,currency:n,timestamp:Date.now()}),this.updateStaffBalance(e,t,n)}async closeDrawer(e,t,n){await this.eventEngine.createEvent(d.t.CASH_DRAWER_CLOSED,e,{staffId:e,closingBalance:t,currency:n,timestamp:Date.now()})}updateStaffBalance(e,t,n){let i=this.cashBalances.get(e)||{staffId:e,staffName:"",currentBalance:0,currency:n,lastUpdated:Date.now(),responsibility:"cashier"};i.currentBalance+=t,i.lastUpdated=Date.now(),this.cashBalances.set(e,i)}resetStaffBalance(e){let t=this.cashBalances.get(e);t&&(t.currentBalance=0,t.lastUpdated=Date.now(),this.cashBalances.set(e,t))}getStaffBalance(e){return this.cashBalances.get(e)||null}getAllBalances(){return Array.from(this.cashBalances.values()).filter(e=>e.currentBalance>0)}calculateDenominationBreakdown(e){let t=[],n=Math.round(100*e)/100;for(let e of this.denominationValues)if(n>=e){let i=Math.floor(n/e);t.push({denomination:e,count:i,total:i*e}),n=Math.round((n-i*e)*100)/100}return t}analyzeCashVariance(e){if(0===e.length)return{totalVariance:0,averageVariance:0,overCount:0,shortCount:0,balancedCount:0,worstVariance:0,bestVariance:0};let t=e.reduce((e,t)=>e+t.variance,0),n=e.filter(e=>"over"===e.status).length,i=e.filter(e=>"short"===e.status).length,a=e.filter(e=>"balanced"===e.status).length,r=e.map(e=>e.variance);return{totalVariance:t,averageVariance:t/e.length,overCount:n,shortCount:i,balancedCount:a,worstVariance:Math.min(...r),bestVariance:Math.max(...r)}}getStaffPerformance(e,t){let n;let i=t.filter(t=>t.staffId===e);if(0===i.length)return{totalShifts:0,accuracyPercent:100,averageVariance:0,rating:"excellent"};let a=i.filter(e=>"balanced"===e.status).length/i.length*100,r=i.reduce((e,t)=>e+Math.abs(t.variance),0)/i.length;return n=a>=95?"excellent":a>=85?"good":a>=70?"needs-improvement":"poor",{totalShifts:i.length,accuracyPercent:a,averageVariance:r,rating:n}}constructor(e){this.cashBalances=new Map,this.denominationValues=[200,100,50,20,10,5,1,.5,.25],this.eventEngine=e}}(i=r||(r={})).ASSET="ASSET",i.LIABILITY="LIABILITY",i.EQUITY="EQUITY",i.REVENUE="REVENUE",i.EXPENSE="EXPENSE",(a=s||(s={})).CASH_ON_HAND="1000",a.BANK_CHECKING="1010",a.INVENTORY_ASSET="1200",a.ACCOUNTS_RECEIVABLE="1300",a.ACCOUNTS_PAYABLE="2000",a.SALES_TAX_PAYABLE="2100",a.OWNERS_EQUITY="3000",a.RETAINED_EARNINGS="3100",a.SALES_REVENUE="4000",a.SERVICE_REVENUE="4100",a.COST_OF_GOODS_SOLD="5000",a.RENT_EXPENSE="5100",a.SALARIES_EXPENSE="5200",a.UTILITIES_EXPENSE="5300",a.WASTE_EXPENSE="5400";let A=[{code:"1000",name:"Cash on Hand",type:"ASSET",balance:0},{code:"1010",name:"Bank Checking",type:"ASSET",balance:0},{code:"1200",name:"Inventory Asset",type:"ASSET",balance:0},{code:"1300",name:"Accounts Receivable",type:"ASSET",balance:0},{code:"2000",name:"Accounts Payable",type:"LIABILITY",balance:0},{code:"2100",name:"Sales Tax Payable",type:"LIABILITY",balance:0},{code:"3000",name:"Owners Equity",type:"EQUITY",balance:0},{code:"3100",name:"Retained Earnings",type:"EQUITY",balance:0},{code:"4000",name:"Sales Revenue",type:"REVENUE",balance:0},{code:"5000",name:"Cost of Goods Sold",type:"EXPENSE",balance:0},{code:"5400",name:"Waste / Spoilage",type:"EXPENSE",balance:0}];class p{initializeAccounts(){A.forEach(e=>{this.accounts.set(e.code,{...e})})}async processEvent(e){let t=null;switch(e.type){case d.t.ORDER_SUBMITTED:t=this.handleOrderSubmitted(e);break;case d.t.PAYMENT_COLLECTED_CASH:t=this.handlePaymentCash(e);break;case d.t.PAYMENT_COLLECTED_CARD:t=this.handlePaymentCard(e);break;case d.t.INVENTORY_DEDUCTED:t=this.handleInventoryDeduction(e)}t&&await this.postEntry(t)}handleOrderSubmitted(e){let t=e.payload,n=t.subtotal||0,i=t.taxAmount||0,a=t.totalAmount||0;return{id:(0,E.Z)(),date:e.timestamp,referenceId:e.id,description:"Order Revenue: ".concat(t.orderId),postedBy:e.actorId,branchId:e.branchId,lines:[{accountCode:s.ACCOUNTS_RECEIVABLE,debit:a,credit:0,description:"Order ".concat(t.orderId)},{accountCode:s.SALES_REVENUE,debit:0,credit:n,description:"Sales Revenue"},{accountCode:s.SALES_TAX_PAYABLE,debit:0,credit:i,description:"Sales Tax"}]}}handlePaymentCash(e){let t=e.payload,n=t.amount||0;return{id:(0,E.Z)(),date:e.timestamp,referenceId:e.id,description:"Cash Payment: ".concat(t.orderId),postedBy:e.actorId,branchId:e.branchId,lines:[{accountCode:s.CASH_ON_HAND,debit:n,credit:0,description:"Cash Received"},{accountCode:s.ACCOUNTS_RECEIVABLE,debit:0,credit:n,description:"Clearing AR"}]}}handlePaymentCard(e){let t=e.payload,n=t.amount||0;return{id:(0,E.Z)(),date:e.timestamp,referenceId:e.id,description:"Card Payment: ".concat(t.orderId),postedBy:e.actorId,branchId:e.branchId,lines:[{accountCode:s.BANK_CHECKING,debit:n,credit:0,description:"Card Settlement"},{accountCode:s.ACCOUNTS_RECEIVABLE,debit:0,credit:n,description:"Clearing AR"}]}}handleInventoryDeduction(e){let t=e.payload;return{id:(0,E.Z)(),date:e.timestamp,referenceId:e.id,description:"COGS: ".concat(t.ingredientName),postedBy:e.actorId,branchId:e.branchId,lines:[{accountCode:s.COST_OF_GOODS_SOLD,debit:5,credit:0,description:"Cost of ".concat(t.ingredientName)},{accountCode:s.INVENTORY_ASSET,debit:0,credit:5,description:"Inventory Usage"}]}}async postEntry(e){let t=e.lines.reduce((e,t)=>e+t.debit,0);if(Math.abs(t-e.lines.reduce((e,t)=>e+t.credit,0))>.01){console.error("Unbalanced Journal Entry ignored",e);return}e.lines.forEach(e=>{let t=this.accounts.get(e.accountCode);t&&(e.debit,e.credit,["ASSET","EXPENSE"].includes(t.type)?t.balance+=e.debit-e.credit:t.balance+=e.credit-e.debit)}),await this.ledger.insertJournalEntry(e),console.log("[Journal] Posted Entry: ".concat(e.description," | Value: ").concat(t))}getReport(e){let t={};if("PL"===e){let e=Array.from(this.accounts.values()).filter(e=>"REVENUE"===e.type),n=Array.from(this.accounts.values()).filter(e=>"EXPENSE"===e.type);t.revenue=e,t.totalRevenue=e.reduce((e,t)=>e+t.balance,0),t.expenses=n,t.totalExpenses=n.reduce((e,t)=>e+t.balance,0),t.netProfit=t.totalRevenue-t.totalExpenses}return t}constructor(e){this.ledger=e,this.accounts=new Map,this.initializeAccounts()}}class N{async processEvent(e){if(!e.actorId)return;let t=e.actorId,n={};e.type===d.t.ORDER_SUBMITTED&&(n.salesCount=1),await this.ledger.updateStaffReputation(t,"Staff Member",n)}constructor(e){this.ledger=e}}class D{async generateForecast(e){let t={dateKey:e,predictedRevenue:15250,predictedItems:{1:42,2:28,4:50},confidenceScore:.85};return await this.ledger.saveForecast(t),t}constructor(e){this.ledger=e}}var g=n(257);let f=(0,o.createContext)(void 0),_=()=>{let e=(0,o.useContext)(f);if(!e)throw Error("usePOS must be used within POSProvider");return e};function v(e){let{children:t}=e,[n,i]=(0,o.useState)(!1),[a,r]=(0,o.useState)(!0),[s,E]=(0,o.useState)(0),[d]=(0,o.useState)(()=>{{let e=localStorage.getItem("nilelink_device_id");return e||(e="device-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),localStorage.setItem("nilelink_device_id",e)),e}}),[u]=(0,o.useState)(()=>localStorage.getItem("nilelink_branch_id")||"branch-cairo-grill"),[h,A]=(0,o.useState)({eventEngine:null,localLedger:null,syncWorker:null,recipeEngine:null,cashEngine:null,journalEngine:null,reputationEngine:null,intelligenceEngine:null});return(0,o.useEffect)(()=>{(async()=>{try{let e=new T,t=await e.getLastEventHash(),n=new l(d,u);t&&n.setLastEventHash(t);let a=g.env.NEXT_PUBLIC_API_URL||"http://localhost:8787",r=new I(e,a),s=new S;s.seed();let c=new R(n),o=new p(e),h=new N(e),f=new D(e);A({eventEngine:n,localLedger:e,syncWorker:r,recipeEngine:s,cashEngine:c,journalEngine:o,reputationEngine:h,intelligenceEngine:f}),r.start(),i(!0),console.log("✅ POS Engines initialized",{deviceId:d,branchId:u,lastHash:t});let _=await e.getUnsyncedEvents();E(_.length)}catch(e){console.error("❌ Failed to initialize POS engines:",e)}})()},[d,u]),(0,o.useEffect)(()=>{let e=()=>r(!0),t=()=>r(!1);return window.addEventListener("online",e),window.addEventListener("offline",t),r(navigator.onLine),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",t)}},[]),(0,o.useEffect)(()=>{let e=setInterval(async()=>{h.localLedger&&E((await h.localLedger.getUnsyncedEvents()).length)},5e3);return()=>clearInterval(e)},[h.localLedger]),(0,c.jsx)(f.Provider,{value:{...h,isInitialized:n,isOnline:a,unsyncedCount:s,deviceId:d,branchId:u},children:t})}},1418:function(e,t,n){"use strict";var i,a;n.d(t,{t:function(){return i}}),(a=i||(i={})).ORDER_CREATED="ORDER_CREATED",a.ORDER_ITEM_ADDED="ORDER_ITEM_ADDED",a.ORDER_ITEM_REMOVED="ORDER_ITEM_REMOVED",a.ORDER_MODIFIED="ORDER_MODIFIED",a.ORDER_SUBMITTED="ORDER_SUBMITTED",a.ORDER_CANCELLED="ORDER_CANCELLED",a.ITEM_PREPARATION_STARTED="ITEM_PREPARATION_STARTED",a.ITEM_PREPARATION_COMPLETED="ITEM_PREPARATION_COMPLETED",a.ORDER_READY="ORDER_READY",a.ORDER_SERVED="ORDER_SERVED",a.PAYMENT_INITIATED="PAYMENT_INITIATED",a.PAYMENT_COLLECTED_CASH="PAYMENT_COLLECTED_CASH",a.PAYMENT_COLLECTED_CARD="PAYMENT_COLLECTED_CARD",a.PAYMENT_COLLECTED_DIGITAL="PAYMENT_COLLECTED_DIGITAL",a.PAYMENT_FAILED="PAYMENT_FAILED",a.PAYMENT_REFUNDED="PAYMENT_REFUNDED",a.INVENTORY_DEDUCTED="INVENTORY_DEDUCTED",a.INVENTORY_ADDED="INVENTORY_ADDED",a.INVENTORY_ADJUSTED="INVENTORY_ADJUSTED",a.INVENTORY_COUNTED="INVENTORY_COUNTED",a.INVENTORY_WASTE_LOGGED="INVENTORY_WASTE_LOGGED",a.INVENTORY_TRANSFERRED="INVENTORY_TRANSFERRED",a.CASH_DRAWER_OPENED="CASH_DRAWER_OPENED",a.CASH_DRAWER_CLOSED="CASH_DRAWER_CLOSED",a.CASH_SALE_COLLECTED="CASH_SALE_COLLECTED",a.CASH_DELIVERY_COLLECTED="CASH_DELIVERY_COLLECTED",a.CASH_HANDOVER="CASH_HANDOVER",a.CASH_BANK_DEPOSIT="CASH_BANK_DEPOSIT",a.CASH_RECONCILIATION="CASH_RECONCILIATION",a.STAFF_SHIFT_STARTED="STAFF_SHIFT_STARTED",a.STAFF_SHIFT_ENDED="STAFF_SHIFT_ENDED",a.STAFF_BREAK_STARTED="STAFF_BREAK_STARTED",a.STAFF_BREAK_ENDED="STAFF_BREAK_ENDED",a.STAFF_ACTION_LOGGED="STAFF_ACTION_LOGGED",a.DELIVERY_ASSIGNED="DELIVERY_ASSIGNED",a.DELIVERY_PICKED_UP="DELIVERY_PICKED_UP",a.DELIVERY_IN_TRANSIT="DELIVERY_IN_TRANSIT",a.DELIVERY_COMPLETED="DELIVERY_COMPLETED",a.DELIVERY_FAILED="DELIVERY_FAILED",a.SUPPLIER_ORDER_CREATED="SUPPLIER_ORDER_CREATED",a.SUPPLIER_ORDER_RECEIVED="SUPPLIER_ORDER_RECEIVED",a.SUPPLIER_ORDER_VERIFIED="SUPPLIER_ORDER_VERIFIED",a.SUPPLIER_PAYMENT_MADE="SUPPLIER_PAYMENT_MADE",a.BRANCH_OPENED="BRANCH_OPENED",a.BRANCH_CLOSED="BRANCH_CLOSED",a.SYSTEM_CONFIG_CHANGED="SYSTEM_CONFIG_CHANGED",a.DATA_SYNC_STARTED="DATA_SYNC_STARTED",a.DATA_SYNC_COMPLETED="DATA_SYNC_COMPLETED"}}]);