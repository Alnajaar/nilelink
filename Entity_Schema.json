{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://nilelink.org/schemas/entity-schema-0.1.json",
  "title": "NileLink Protocol â€” Entity Schema (v0.1)",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "version": { "const": "0.1" },
    "entities": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "Restaurant": { "$ref": "#/$defs/Restaurant" },
        "Order": { "$ref": "#/$defs/Order" },
        "Transaction": { "$ref": "#/$defs/Transaction" },
        "InventoryItem": { "$ref": "#/$defs/InventoryItem" },
        "Delivery": { "$ref": "#/$defs/Delivery" },
        "SupplierInvoice": { "$ref": "#/$defs/SupplierInvoice" },
        "InvestorAccount": { "$ref": "#/$defs/InvestorAccount" }
      },
      "required": [
        "Restaurant",
        "Order",
        "Transaction",
        "InventoryItem",
        "Delivery",
        "SupplierInvoice",
        "InvestorAccount"
      ]
    }
  },
  "required": ["version", "entities"],
  "$defs": {
    "EthAddress": {
      "type": "string",
      "pattern": "^0x[a-fA-F0-9]{40}$",
      "description": "Ethereum-compatible address (EIP-55 checksum recommended)."
    },
    "PolygonTxHash": {
      "type": "string",
      "pattern": "^0x[a-fA-F0-9]{64}$",
      "description": "Polygon transaction hash (0x + 32 bytes)."
    },
    "UUIDv4": {
      "type": "string",
      "format": "uuid",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
    },
    "ISODateTime": {
      "type": "string",
      "format": "date-time",
      "description": "RFC3339 / ISO-8601 timestamp in UTC preferred."
    },
    "PhoneE164": {
      "type": "string",
      "pattern": "^\\+[1-9]\\d{1,14}$",
      "description": "International E.164 phone number format."
    },
    "ISO3166Alpha2": {
      "type": "string",
      "pattern": "^[A-Z]{2}$"
    },
    "ISO4217": {
      "type": "string",
      "pattern": "^[A-Z]{3}$"
    },
    "MoneyUsd": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)(\\.\\d{1,6})?$",
      "description": "Decimal string in USD with up to 6 decimals (USDC-compatible)."
    },
    "MoneyLocal": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)(\\.\\d{1,6})?$",
      "description": "Decimal string in the restaurant local currency with up to 6 decimals."
    },
    "LocalizedName": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "en": { "type": "string", "minLength": 1, "maxLength": 256 },
        "ar": { "type": "string", "minLength": 1, "maxLength": 256 }
      },
      "required": ["en", "ar"],
      "description": "Arabic + English localized fields."
    },
    "GeoPoint": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "lat": { "type": "number", "minimum": -90, "maximum": 90 },
        "lng": { "type": "number", "minimum": -180, "maximum": 180 }
      },
      "required": ["lat", "lng"]
    },
    "CustomerId": {
      "description": "Either a wallet address OR a stable phone hash (preferred: SHA-256 or keccak256 of E.164 + salt).",
      "oneOf": [
        { "$ref": "#/$defs/EthAddress" },
        {
          "type": "string",
          "pattern": "^0x[a-fA-F0-9]{64}$",
          "description": "32-byte hex hash"
        }
      ]
    },

    "Restaurant": {
      "type": "object",
      "additionalProperties": false,
      "x-immutableFields": ["id", "createdAt"],
      "properties": {
        "id": { "$ref": "#/$defs/EthAddress", "x-immutable": true },
        "ownerPhoneNumber": { "$ref": "#/$defs/PhoneE164" },
        "legalName": { "$ref": "#/$defs/LocalizedName" },
        "localName": { "$ref": "#/$defs/LocalizedName" },
        "country": { "$ref": "#/$defs/ISO3166Alpha2" },
        "localCurrency": { "$ref": "#/$defs/ISO4217" },
        "dailyRateLimit": {
          "$ref": "#/$defs/MoneyUsd",
          "description": "Daily settlement cap in USD. Implementations SHOULD enforce on-chain and off-chain."
        },
        "timezone": { "type": "string", "minLength": 1, "maxLength": 64, "description": "IANA timezone (e.g., Asia/Beirut)." },
        "taxPercentage": { "type": "number", "minimum": 0, "maximum": 100 },
        "chainlinkOracleAddress": { "$ref": "#/$defs/EthAddress" },
        "status": { "type": "string", "enum": ["ACTIVE", "SUSPENDED", "INACTIVE"] },
        "createdAt": { "$ref": "#/$defs/ISODateTime", "x-immutable": true },
        "lastModified": { "$ref": "#/$defs/ISODateTime" }
      },
      "required": [
        "id",
        "ownerPhoneNumber",
        "legalName",
        "localName",
        "country",
        "localCurrency",
        "dailyRateLimit",
        "timezone",
        "taxPercentage",
        "chainlinkOracleAddress",
        "status",
        "createdAt",
        "lastModified"
      ],
      "x-relationships": {
        "orders": { "type": "one-to-many", "target": "Order", "foreignKey": "restaurantId" },
        "inventory": { "type": "one-to-many", "target": "InventoryItem", "foreignKey": "restaurantId" }
      }
    },

    "OrderItem": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "sku": { "type": "string", "minLength": 1, "maxLength": 64 },
        "name": { "$ref": "#/$defs/LocalizedName" },
        "qty": { "type": "integer", "minimum": 1, "maximum": 1000 },
        "unitPrice": { "$ref": "#/$defs/MoneyUsd" },
        "modifiers": {
          "type": "array",
          "items": { "type": "string", "maxLength": 128 },
          "maxItems": 50,
          "default": []
        }
      },
      "required": ["sku", "name", "qty", "unitPrice", "modifiers"]
    },

    "Order": {
      "type": "object",
      "additionalProperties": false,
      "x-immutableFields": ["id", "restaurantId", "createdAt"],
      "properties": {
        "id": { "$ref": "#/$defs/UUIDv4", "x-immutable": true },
        "restaurantId": { "$ref": "#/$defs/EthAddress", "x-immutable": true },
        "customerId": { "$ref": "#/$defs/CustomerId" },
        "items": { "type": "array", "items": { "$ref": "#/$defs/OrderItem" }, "minItems": 1 },
        "subtotal": { "$ref": "#/$defs/MoneyUsd" },
        "localSubtotal": { "$ref": "#/$defs/MoneyLocal" },
        "tax": { "$ref": "#/$defs/MoneyUsd" },
        "deliveryFee": { "$ref": "#/$defs/MoneyUsd" },
        "total": { "$ref": "#/$defs/MoneyUsd" },
        "localTotal": { "$ref": "#/$defs/MoneyLocal" },
        "exchangeRate": {
          "type": "string",
          "pattern": "^(0|[1-9]\\d*)(\\.\\d{1,12})?$",
          "description": "Snapshot rate at order time: local currency per 1 USD."
        },
        "status": {
          "type": "string",
          "enum": [
            "CREATED",
            "PAID",
            "CONFIRMED",
            "COOKING",
            "READY",
            "PICKED_UP",
            "DELIVERED",
            "CANCELLED"
          ]
        },
        "paymentMethod": { "type": "string", "enum": ["BLOCKCHAIN", "FIAT", "NILE_FUTURE"] },
        "blockchainTxHash": { "$ref": "#/$defs/PolygonTxHash" },
        "deliveryPartnerAssignedTo": { "type": ["string", "null"], "maxLength": 128 },
        "createdAt": { "$ref": "#/$defs/ISODateTime", "x-immutable": true },
        "completedAt": { "anyOf": [{ "$ref": "#/$defs/ISODateTime" }, { "type": "null" }] },
        "orderNotes": { "type": "string", "maxLength": 2000, "default": "" },
        "kitchenNotes": { "type": "string", "maxLength": 2000, "default": "" }
      },
      "required": [
        "id",
        "restaurantId",
        "customerId",
        "items",
        "subtotal",
        "localSubtotal",
        "tax",
        "deliveryFee",
        "total",
        "localTotal",
        "exchangeRate",
        "status",
        "paymentMethod",
        "blockchainTxHash",
        "deliveryPartnerAssignedTo",
        "createdAt",
        "completedAt",
        "orderNotes",
        "kitchenNotes"
      ],
      "x-constraints": [
        "total == subtotal + tax + deliveryFee",
        "localTotal == localSubtotal + (tax * exchangeRate) + (deliveryFee * exchangeRate)"
      ]
    },

    "Transaction": {
      "type": "object",
      "additionalProperties": false,
      "x-immutableFields": ["id", "orderId", "fromWallet", "toWallet", "timestamp", "blockNumber"],
      "properties": {
        "id": { "$ref": "#/$defs/PolygonTxHash", "x-immutable": true },
        "orderId": { "$ref": "#/$defs/UUIDv4", "x-immutable": true },
        "fromWallet": { "$ref": "#/$defs/EthAddress", "x-immutable": true },
        "toWallet": { "$ref": "#/$defs/EthAddress", "x-immutable": true },
        "amountUSD": { "$ref": "#/$defs/MoneyUsd" },
        "amountLocal": { "$ref": "#/$defs/MoneyLocal" },
        "rate": { "type": "string", "pattern": "^(0|[1-9]\\d*)(\\.\\d{1,12})?$" },
        "fee": { "$ref": "#/$defs/MoneyUsd", "description": "Protocol fee (0.5% default)." },
        "status": { "type": "string", "enum": ["PENDING", "CONFIRMED", "SETTLED", "DISPUTED", "REFUNDED"] },
        "timestamp": { "$ref": "#/$defs/ISODateTime", "x-immutable": true },
        "blockNumber": { "type": "integer", "minimum": 0, "x-immutable": true },
        "gasUsed": { "type": "integer", "minimum": 0 }
      },
      "required": [
        "id",
        "orderId",
        "fromWallet",
        "toWallet",
        "amountUSD",
        "amountLocal",
        "rate",
        "fee",
        "status",
        "timestamp",
        "blockNumber",
        "gasUsed"
      ]
    },

    "InventoryEvent": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "eventId": { "type": "string", "minLength": 10, "maxLength": 64 },
        "type": { "type": "string" },
        "delta": { "type": "integer" },
        "oldQty": { "type": "integer", "minimum": 0 },
        "newQty": { "type": "integer", "minimum": 0 },
        "reason": { "type": "string", "maxLength": 128 },
        "occurredAt": { "$ref": "#/$defs/ISODateTime" },
        "actorId": { "type": "string", "maxLength": 128 }
      },
      "required": ["eventId", "type", "delta", "oldQty", "newQty", "reason", "occurredAt", "actorId"]
    },

    "InventoryItem": {
      "type": "object",
      "additionalProperties": false,
      "x-immutableFields": ["id", "restaurantId"],
      "properties": {
        "id": { "type": "string", "minLength": 1, "maxLength": 64, "x-immutable": true, "description": "SKU" },
        "restaurantId": { "$ref": "#/$defs/EthAddress", "x-immutable": true },
        "name": { "$ref": "#/$defs/LocalizedName" },
        "category": {
          "type": "string",
          "enum": ["appetizer", "main", "beverage", "dessert", "side", "sauce", "other"]
        },
        "qty": { "type": "integer", "minimum": 0 },
        "minQty": { "type": "integer", "minimum": 0 },
        "supplier": { "$ref": "#/$defs/EthAddress" },
        "costPerUnit": { "$ref": "#/$defs/MoneyUsd" },
        "sellingPrice": { "$ref": "#/$defs/MoneyUsd" },
        "profit%": { "type": "number", "minimum": -1000, "maximum": 1000, "description": "Computed: ((sellingPrice - costPerUnit)/sellingPrice)*100" },
        "lastRestocked": { "$ref": "#/$defs/ISODateTime" },
        "expiryDate": { "anyOf": [{ "type": "string", "format": "date" }, { "type": "null" }] },
        "eventLog": {
          "type": "array",
          "items": { "$ref": "#/$defs/InventoryEvent" },
          "description": "Immutable history of all quantity changes.",
          "x-immutable": true
        }
      },
      "required": [
        "id",
        "restaurantId",
        "name",
        "category",
        "qty",
        "minQty",
        "supplier",
        "costPerUnit",
        "sellingPrice",
        "profit%",
        "lastRestocked",
        "expiryDate",
        "eventLog"
      ]
    },

    "Delivery": {
      "type": "object",
      "additionalProperties": false,
      "x-immutableFields": ["id", "orderId", "restaurantId", "createdAt"],
      "properties": {
        "id": { "$ref": "#/$defs/UUIDv4", "x-immutable": true },
        "orderId": { "$ref": "#/$defs/UUIDv4", "x-immutable": true },
        "restaurantId": { "$ref": "#/$defs/EthAddress", "x-immutable": true },
        "deliveryPartnerId": { "type": "string", "minLength": 1, "maxLength": 128 },
        "customerLocation": { "$ref": "#/$defs/GeoPoint" },
        "restaurantLocation": { "$ref": "#/$defs/GeoPoint" },
        "pickupTime": { "anyOf": [{ "$ref": "#/$defs/ISODateTime" }, { "type": "null" }] },
        "deliveryTime": { "anyOf": [{ "$ref": "#/$defs/ISODateTime" }, { "type": "null" }] },
        "actualPickupTime": { "anyOf": [{ "$ref": "#/$defs/ISODateTime" }, { "type": "null" }] },
        "actualDeliveryTime": { "anyOf": [{ "$ref": "#/$defs/ISODateTime" }, { "type": "null" }] },
        "distance": { "type": "number", "minimum": 0, "description": "km" },
        "baseFee": { "$ref": "#/$defs/MoneyUsd" },
        "tipAmount": { "$ref": "#/$defs/MoneyUsd" },
        "totalFee": { "$ref": "#/$defs/MoneyUsd" },
        "status": { "type": "string", "enum": ["ASSIGNED", "PICKED_UP", "IN_TRANSIT", "DELIVERED", "CANCELLED"] },
        "route": {
          "type": "array",
          "items": { "$ref": "#/$defs/GeoPoint" },
          "description": "Optional multi-stop route",
          "default": []
        },
        "rating": { "anyOf": [{ "type": "integer", "minimum": 1, "maximum": 5 }, { "type": "null" }] },
        "feedback": { "type": "string", "maxLength": 2000, "default": "" },
        "createdAt": { "$ref": "#/$defs/ISODateTime", "x-immutable": true }
      },
      "required": [
        "id",
        "orderId",
        "restaurantId",
        "deliveryPartnerId",
        "customerLocation",
        "restaurantLocation",
        "pickupTime",
        "deliveryTime",
        "actualPickupTime",
        "actualDeliveryTime",
        "distance",
        "baseFee",
        "tipAmount",
        "totalFee",
        "status",
        "route",
        "rating",
        "feedback",
        "createdAt"
      ],
      "x-constraints": ["totalFee == baseFee + tipAmount"]
    },

    "SupplierInvoiceItem": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "product": { "type": "string", "minLength": 1, "maxLength": 256 },
        "qty": { "type": "integer", "minimum": 1 },
        "unitPrice": { "$ref": "#/$defs/MoneyUsd" },
        "subtotal": { "$ref": "#/$defs/MoneyUsd" }
      },
      "required": ["product", "qty", "unitPrice", "subtotal"]
    },

    "SupplierInvoice": {
      "type": "object",
      "additionalProperties": false,
      "x-immutableFields": ["id", "supplierId", "restaurantId", "createdAt"],
      "properties": {
        "id": { "$ref": "#/$defs/UUIDv4", "x-immutable": true },
        "supplierId": {
          "description": "Supplier identifier: E.164 phone or on-chain address.",
          "oneOf": [{ "$ref": "#/$defs/PhoneE164" }, { "$ref": "#/$defs/EthAddress" }]
        },
        "restaurantId": { "$ref": "#/$defs/EthAddress", "x-immutable": true },
        "items": { "type": "array", "items": { "$ref": "#/$defs/SupplierInvoiceItem" }, "minItems": 1 },
        "dueDate": { "type": "string", "format": "date" },
        "paymentTerms": { "type": "string", "enum": ["COD", "Net-30", "Net-60"] },
        "totalAmount": { "$ref": "#/$defs/MoneyUsd" },
        "paidAmount": { "$ref": "#/$defs/MoneyUsd" },
        "remainingBalance": { "$ref": "#/$defs/MoneyUsd" },
        "status": {
          "type": "string",
          "enum": ["DRAFT", "SENT", "RECEIVED", "PARTIALLY_PAID", "SETTLED"]
        },
        "proofOfDelivery": { "type": "string", "pattern": "^0x[a-fA-F0-9]{64}$", "description": "Hash of POD document" },
        "blockchainSettlementTxHash": { "anyOf": [{ "$ref": "#/$defs/PolygonTxHash" }, { "type": "null" }] },
        "createdAt": { "$ref": "#/$defs/ISODateTime", "x-immutable": true }
      },
      "required": [
        "id",
        "supplierId",
        "restaurantId",
        "items",
        "dueDate",
        "paymentTerms",
        "totalAmount",
        "paidAmount",
        "remainingBalance",
        "status",
        "proofOfDelivery",
        "blockchainSettlementTxHash",
        "createdAt"
      ],
      "x-constraints": ["remainingBalance == totalAmount - paidAmount"]
    },

    "InvestorAccount": {
      "type": "object",
      "additionalProperties": false,
      "x-immutableFields": ["id", "investorWallet", "investmentDate"],
      "properties": {
        "id": { "$ref": "#/$defs/UUIDv4", "x-immutable": true },
        "investorWallet": { "$ref": "#/$defs/EthAddress", "x-immutable": true },
        "restaurantId": {
          "description": "Single-restaurant investment. For multi-restaurant portfolios use `portfolioRestaurantIds`.",
          "anyOf": [{ "$ref": "#/$defs/EthAddress" }, { "type": "null" }]
        },
        "portfolioRestaurantIds": {
          "type": "array",
          "items": { "$ref": "#/$defs/EthAddress" },
          "default": []
        },
        "investmentAmount": { "$ref": "#/$defs/MoneyUsd" },
        "investmentDate": { "$ref": "#/$defs/ISODateTime", "x-immutable": true },
        "ownership%": { "type": "number", "minimum": 0, "maximum": 100 },
        "dividendRecipientWallet": { "$ref": "#/$defs/EthAddress" },
        "performanceMetrics": {
          "type": "object",
          "additionalProperties": true,
          "description": "Real-time KPIs (revenue, orders/day, margin, etc.)."
        },
        "status": { "type": "string", "enum": ["ACTIVE", "DORMANT", "EXITED"] }
      },
      "required": [
        "id",
        "investorWallet",
        "restaurantId",
        "portfolioRestaurantIds",
        "investmentAmount",
        "investmentDate",
        "ownership%",
        "dividendRecipientWallet",
        "performanceMetrics",
        "status"
      ]
    }
  }
}
