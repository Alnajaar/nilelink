# Database Migrations Guide

## Overview
This directory contains all database migrations for the NileLink backend. Migrations are automatically generated by Prisma and ensure safe, incremental database schema updates.

## Migration Commands

### Development
```bash
# Generate migration from schema changes
npm run prisma:migrate:dev

# Reset database (development only)
npm run prisma:migrate:reset

# View migration status
npm run prisma:migrate:status
```

### Production
```bash
# Apply pending migrations
npm run prisma:migrate:deploy

# Create baseline migration (for existing databases)
npm run prisma:migrate:resolve
```

## Migration Files

### Naming Convention
`YYYYMMDDHHMMSS_descriptive_name`

### File Structure
```
migrations/
├── 20240101000000_initial_schema/
│   ├── migration.sql
│   └── README.md
├── 20240102000000_add_event_sourcing/
│   ├── migration.sql
│   └── README.md
└── README.md
```

## Safety Checks

Before applying migrations in production:

1. **Backup Database**
   ```bash
   pg_dump nilelink > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **Dry Run** (if supported by your PostgreSQL version)
   ```bash
   psql -h localhost -U user -d nilelink -f migration.sql --dry-run
   ```

3. **Test on Staging First**
   - Apply to staging environment
   - Run full test suite
   - Verify application functionality

4. **Monitor During Deployment**
   - Check application logs
   - Monitor database performance
   - Be ready to rollback

## Rollback Procedures

### Automatic Rollback (if migration fails)
Prisma Migrate will automatically rollback failed migrations.

### Manual Rollback
```bash
# Mark migration as rolled back
npm run prisma:migrate:resolve --applied 20240101000000_migration_name

# Or downgrade to previous version
npm run prisma:db:push --force-reset
```

## Migration Best Practices

1. **Test on Development First**
2. **Small, Incremental Changes**
3. **Backward Compatible When Possible**
4. **Document Breaking Changes**
5. **Backup Before Production Deployment**
6. **Monitor Performance Impact**

## Troubleshooting

### Migration Fails
1. Check database connection
2. Verify permissions
3. Review migration SQL
4. Check for conflicting data

### Performance Issues
1. Large tables may require special handling
2. Consider adding indexes in separate migration
3. Monitor query performance post-migration

### Rollback Issues
1. Some operations are not easily reversible
2. Have data backup ready
3. Test rollback procedures in staging