datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// EVENT SOURCING MODELS
// ============================================================================

model DomainEvent {
  id            String   @id @default(cuid())
  eventType     String
  aggregateId   String
  aggregateType String
  eventData     String // Encrypted JSON
  eventDataIv   String // Initialization vector for encryption
  eventDataHash String // Integrity hash
  metadata      Json? // Additional metadata
  timestamp     DateTime
  version       Int
  correlationId String?
  causationId   String?

  createdAt DateTime @default(now())

  @@index([aggregateId, aggregateType])
  @@index([eventType])
  @@index([timestamp])
  @@index([version])
}

model AggregateVersion {
  aggregateId   String
  aggregateType String
  version       Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@id([aggregateId, aggregateType])
  @@index([aggregateType])
}

model EventSnapshot {
  id            String   @id @default(cuid())
  aggregateId   String
  aggregateType String
  snapshotData  Json // Encrypted JSON
  version       Int
  timestamp     DateTime

  createdAt DateTime @default(now())

  @@unique([aggregateId, aggregateType, version])
  @@index([aggregateId, aggregateType])
  @@index([timestamp])
}

// ============================================================================
// AUDIT & COMPLIANCE MODELS
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String // CREATE, UPDATE, DELETE, LOGIN, etc.
  resource   String // user, order, payment, etc.
  resourceId String?
  oldValues  Json? // Previous state
  newValues  Json? // New state
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())
  sessionId  String?

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([timestamp])
}

model ComplianceRecord {
  id          String           @id @default(cuid())
  type        ComplianceType
  referenceId String // ID of related record
  status      ComplianceStatus @default(PENDING)
  details     Json? // Compliance check details
  expiresAt   DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([type])
  @@index([status])
  @@index([expiresAt])
}

enum ComplianceType {
  KYC
  AML
  GDPR_CONSENT
  PCI_DSS
  SOC2
}

enum ComplianceStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

// ============================================================================
// CURRENCY MODELS
// ============================================================================

model Currency {
  id        String   @id @default(cuid())
  code      String   @unique // "USD", "EUR", "EGP", "AED"
  symbol    String // "$", "€", "£", "د.إ"
  name      String // "US Dollar", "Egyptian Pound"
  decimals  Int      @default(2)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  exchangeRatesFrom ExchangeRate[] @relation("FromCurrency")
  exchangeRatesTo   ExchangeRate[] @relation("ToCurrency")

  @@index([code])
  @@index([isActive])
}

model ExchangeRate {
  id               String   @id @default(cuid())
  fromCurrencyCode String   @default("USD")
  toCurrencyCode   String
  fromCurrencyId   String
  fromCurrency     Currency @relation("FromCurrency", fields: [fromCurrencyId], references: [id])
  toCurrencyId     String
  toCurrency       Currency @relation("ToCurrency", fields: [toCurrencyId], references: [id])

  rate        Decimal // 1 USD = 30.95 EGP
  date        DateTime @default(now())
  source      String? // "exchangerate-api.com"
  isLive      Boolean  @default(false)
  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())

  @@unique([fromCurrencyCode, toCurrencyCode, date])
  @@index([fromCurrencyId])
  @@index([toCurrencyId])
  @@index([fromCurrencyCode])
  @@index([toCurrencyCode])
  @@index([date])
  @@index([lastUpdated])
}

// ============================================================================
// MULTI-CHAIN MODELS
// ============================================================================

model ChainConfig {
  id             String   @id @default(cuid())
  name           String   @unique // "polygon", "ethereum", "arbitrum"
  chainId        Int      @unique
  rpcUrl         String
  blockExplorer  String?
  nativeCurrency String   @default("ETH")
  isActive       Boolean  @default(true)
  priority       Int      @default(0) // For failover priority
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([isActive])
  @@index([priority])
}

model CrossChainTx {
  id             String           @id @default(cuid())
  sourceChain    String
  targetChain    String
  sourceTxHash   String           @unique
  targetTxHash   String?          @unique
  status         CrossChainStatus @default(PENDING)
  amount         String // In wei/smallest unit
  tokenAddress   String?
  sender         String
  receiver       String
  bridgeProvider String // "layerzero", "polygon-bridge", etc.
  metadata       Json?
  initiatedAt    DateTime         @default(now())
  completedAt    DateTime?

  @@index([sourceChain])
  @@index([targetChain])
  @@index([status])
  @@index([sender])
  @@index([receiver])
}

enum CrossChainStatus {
  PENDING
  CONFIRMED
  EXECUTING
  COMPLETED
  FAILED
}

// ============================================================================
// TOKEN ECONOMICS MODELS
// ============================================================================

model TokenMetrics {
  id                String   @id @default(cuid())
  totalSupply       String // Total NLINK supply
  circulatingSupply String // Circulating supply
  marketCap         String? // USD market cap
  price             Decimal? // USD price per token
  volume24h         String? // 24h trading volume
  timestamp         DateTime @default(now())

  @@index([timestamp])
}

model StakingPool {
  id             String   @id @default(cuid())
  name           String   @unique
  tokenAddress   String
  rewardRate     Decimal // Annual percentage yield
  totalStaked    String // Total tokens staked
  minStakeAmount String // Minimum stake amount
  lockPeriod     Int // Lock period in days
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  stakes StakePosition[]

  @@index([isActive])
}

model StakePosition {
  id           String      @id @default(cuid())
  poolId       String
  pool         StakingPool @relation(fields: [poolId], references: [id])
  userAddress  String
  amount       String // Staked amount
  rewards      String      @default("0") // Accumulated rewards
  stakedAt     DateTime    @default(now())
  lastRewardAt DateTime    @default(now())
  unlockedAt   DateTime?
  withdrawnAt  DateTime?

  @@unique([poolId, userAddress])
  @@index([userAddress])
  @@index([unlockedAt])
}

// ============================================================================
// GOVERNANCE MODELS
// ============================================================================

model GovernanceProposal {
  id           String         @id @default(cuid())
  proposer     String // Proposer address
  title        String
  description  String
  type         ProposalType
  status       ProposalStatus @default(ACTIVE)
  startBlock   Int
  endBlock     Int
  forVotes     String         @default("0")
  againstVotes String         @default("0")
  abstainVotes String         @default("0")
  executed     Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  votes GovernanceVote[]

  @@index([proposer])
  @@index([status])
  @@index([type])
}

model GovernanceVote {
  id                  String             @id @default(cuid())
  proposalId          String
  proposal            GovernanceProposal @relation(fields: [proposalId], references: [id])
  voter               String
  support             VoteType
  votes               String // Voting power
  reason              String?
  votedAt             DateTime           @default(now())
  GovernanceProfile   GovernanceProfile? @relation(fields: [governanceProfileId], references: [id])
  governanceProfileId String?

  @@unique([proposalId, voter])
  @@index([voter])
}

enum ProposalType {
  PARAMETER_CHANGE
  FUNDING_REQUEST
  PROTOCOL_UPGRADE
  EMERGENCY_PAUSE
}

enum ProposalStatus {
  ACTIVE
  SUCCEEDED
  DEFEATED
  EXECUTED
  CANCELLED
}

enum VoteType {
  FOR
  AGAINST
  ABSTAIN
}

// ============================================================================
// DECENTRALIZED IDENTITY MODELS
// ============================================================================

model DIDDocument {
  id             String    @id @default(cuid())
  did            String    @unique // did:nilelink:0x...
  controller     String // Controller address
  publicKey      String // Public key for verification
  authentication Json? // Authentication methods
  service        Json? // Service endpoints
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  revokedAt      DateTime?

  credentials VerifiableCredential[]
}

model VerifiableCredential {
  id                String      @id @default(cuid())
  issuerDid         String
  issuer            DIDDocument @relation(fields: [issuerDid], references: [did])
  subjectDid        String?
  type              String[] // ["KYC", "Accreditation", etc.]
  credentialSubject Json
  proof             Json // Cryptographic proof
  expirationDate    DateTime?
  issuanceDate      DateTime    @default(now())
  revoked           Boolean     @default(false)
  revokedAt         DateTime?

  @@index([issuerDid])
  @@index([subjectDid])
  @@index([revoked])
}

// ============================================================================
// SESSION MANAGEMENT
// ============================================================================

model Session {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  ipAddress    String
  userAgent    String
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  isActive     Boolean  @default(true)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isActive])
  @@index([expiresAt])
}

// ============================================================================
// MFA MANAGEMENT
// ============================================================================

model MFASecret {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  method      String // 'TOTP', 'SMS', 'EMAIL'
  secret      String
  backupCodes String[] // Encrypted backup codes
  isActive    Boolean   @default(true)
  lastUsed    DateTime?

  createdAt DateTime @default(now())

  @@unique([userId, method])
  @@index([userId])
  @@index([isActive])
}

model MFATempSecret {
  userId    String
  method    String // 'TOTP', 'SMS', 'EMAIL'
  secret    String
  createdAt DateTime @default(now())

  @@unique([userId, method])
  @@index([userId])
}

// ============================================================================
// WALLET MANAGEMENT
// ============================================================================

model WalletChallenge {
  id        String   @id @default(cuid())
  address   String // Ethereum address (lowercase)
  message   String // Signed message
  nonce     String // Unique nonce
  expiresAt DateTime
  used      Boolean  @default(false)
  userId    String? // Optional link to user

  createdAt DateTime @default(now())

  @@index([address])
  @@index([used])
  @@index([expiresAt])
  @@index([userId])
}

model WalletConnection {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  address     String // Ethereum address (lowercase)
  chainId     Int      @default(1) // Ethereum mainnet
  isActive    Boolean  @default(true)
  sessionId   String?
  connectedAt DateTime @default(now())
  lastUsedAt  DateTime @default(now())

  @@unique([userId, address]) // User can only have one active connection per address
  @@index([userId])
  @@index([address])
  @@index([isActive])
}

// ============================================================================
// API KEY MANAGEMENT
// ============================================================================

model APIKey {
  id          String  @id @default(cuid())
  name        String
  description String?
  keyHash     String // Hashed API key
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  permissions String[] // Array of permission strings
  scopes      String[] // Array of scope strings
  isActive    Boolean   @default(true)
  expiresAt   DateTime?

  lastUsedAt DateTime?
  usageCount Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([keyHash])
  @@index([isActive])
  @@index([expiresAt])
}

// ============================================================================
// TENANT MANAGEMENT
// ============================================================================

model Tenant {
  id          String    @id @default(cuid())
  name        String
  subdomain   String    @unique
  plan        String    @default("FREE")
  isActive    Boolean   @default(true)
  trialEndsAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  users       User[]
  restaurants Restaurant[]
  settings    TenantSettings?
  roles       Role[]

  @@index([subdomain])
  @@index([isActive])
  @@index([trialEndsAt])
}

model TenantSettings {
  id       String @id @default(cuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  baseCurrency        String  @default("USD")
  timezone            String  @default("UTC")
  dateFormat          String  @default("YYYY-MM-DD")
  taxRate             Float   @default(0)
  enableInventory     Boolean @default(true)
  enableDelivery      Boolean @default(true)
  enableReservations  Boolean @default(false)
  enableMultiLocation Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// BASE USER & MARKETPLACE MODELS
// ============================================================================

model User {
  id                         String    @id @default(cuid())
  email                      String    @unique
  role                       UserRole  @default(CUSTOMER)
  isActive                   Boolean   @default(false)
  password                   String?
  firstName                  String?
  lastName                   String?
  phone                      String?
  phoneVerified              Boolean   @default(false)
  emailVerified              Boolean   @default(false)
  emailVerificationToken     String?   @unique
  emailVerificationExpiresAt DateTime?
  otpCode                    String?   @unique
  otpExpiresAt               DateTime?
  passwordResetToken         String?   @unique
  passwordResetExpiresAt     DateTime?
  refreshToken               String?   @unique
  refreshTokenExpiresAt      DateTime?
  failedLoginAttempts        Int       @default(0)
  isLocked                   Boolean   @default(false)
  tenantId                   String?
  tenant                     Tenant?   @relation(fields: [tenantId], references: [id])

  // Stripe integration
  stripeCustomerId String? @unique

  walletAddress String?  @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  customerSubscriptions CustomerSubscription[]
  sessions              Session[]
  mfaSecrets            MFASecret[]
  walletConnections     WalletConnection[]
  apiKeys               APIKey[]
  paymentMethods        PaymentMethod[]

  // Profile Relations
  customerProfile CustomerProfile?
  staffProfile    StaffProfile?

  // Ecosystem Relations
  orders             Order[]    @relation("CustomerOrders")
  assignedDeliveries Delivery[] @relation("DriverDeliveries")

  // Neural Loyalty & Gamification
  loyaltyProfile    NeuralLoyaltyProfile?
  governanceProfile GovernanceProfile?
  chaosParticipants NeuralChaosParticipant[]
  meritTransactions MeritTransaction[]
  userAchievements  NeuralUserAchievement[]
  userChallenges    NeuralUserChallenge[]

  // Permissions & Access
  roles Role[]

  @@index([email])
  @@index([walletAddress])
  @@index([emailVerified])
  @@index([isLocked])
  @@index([tenantId])
}

model Role {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  permissions Permission[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Permission {
  id        String   @id @default(cuid())
  resource  String // e.g., "ORDER", "MENU"
  action    String // e.g., "CREATE", "READ"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roles Role[]

  @@unique([resource, action])
}

// ============================================================================
// PAYMENT METHODS
// ============================================================================

model PaymentMethod {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripePaymentMethodId String  @unique
  type                  String // 'card', 'bank_account', etc.
  cardBrand             String?
  cardLast4             String?
  cardExpMonth          Int?
  cardExpYear           Int?

  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([stripePaymentMethodId])
  @@index([isDefault])
  @@index([isActive])
}

model MarketplaceSeller {
  id                String             @id @default(cuid())
  name              String
  email             String             @unique
  description       String?
  logoUrl           String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  subscriptionPlans SubscriptionPlan[]

  @@index([email])
}

// ============================================================================
// STORE SUBSCRIPTION SYSTEM
// ============================================================================

model SubscriptionPlan {
  id       String            @id @default(cuid())
  sellerId String
  seller   MarketplaceSeller @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  name            String
  description     String?
  richDescription String? // Rich text HTML/markdown
  logoUrl         String?
  bannerUrl       String?

  // Pricing and Billing
  price          Decimal
  currency       String       @default("USD")
  billingCycle   BillingCycle @default(MONTHLY)
  trialDays      Int?         @default(0)
  maxSubscribers Int? // Optional limit

  // Visibility
  visibility SubscriptionVisibility @default(PUBLIC)
  inviteCode String?                @unique // For private subscriptions

  // Status and Lifecycle
  status            SubscriptionPlanStatus @default(DRAFT)
  autoRenew         Boolean                @default(true)
  cancellationRules Json? // Custom cancellation policies

  // Technical Gating
  features String[] @default([]) // Array of technical keys e.g. ["analytics_pro", "inventory_advanced"]

  // Analytics
  subscriberCount Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  benefits              SubscriptionBenefit[]
  customerSubscriptions CustomerSubscription[]
  web3Contract          Web3SubscriptionContract?

  // Indexes
  @@index([sellerId])
  @@index([status])
  @@index([visibility])
  @@index([createdAt])
}

enum BillingCycle {
  MONTHLY
  YEARLY
  CUSTOM
}

enum SubscriptionVisibility {
  PUBLIC
  PRIVATE
}

enum SubscriptionPlanStatus {
  DRAFT
  ACTIVE
  PAUSED
  EXPIRED
  CANCELLED
}

model SubscriptionBenefit {
  id     String           @id @default(cuid())
  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  type        BenefitType
  title       String
  description String?
  value       Json? // Flexible value storage (percentage, amount, etc.)

  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Indexes
  @@index([planId])
  @@index([type])
  @@index([displayOrder])
}

enum BenefitType {
  DISCOUNT
  FREE_DELIVERY
  EARLY_ACCESS
  EXCLUSIVE_ITEM
  CUSTOM
}

model CustomerSubscription {
  id         String           @id @default(cuid())
  customerId String
  customer   User             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  planId     String
  plan       SubscriptionPlan @relation(fields: [planId], references: [id])

  // Subscription Details
  status       CustomerSubscriptionStatus @default(PENDING)
  startDate    DateTime                   @default(now())
  endDate      DateTime?
  trialEndDate DateTime?
  cancelledAt  DateTime?
  autoRenew    Boolean                    @default(true)

  // Billing
  lastBilledAt    DateTime?
  nextBillingDate DateTime?
  paymentMethodId String? // Reference to payment method

  // Analytics
  totalPaid    Decimal @default(0)
  renewalCount Int     @default(0)

  // Relations
  transactions SubscriptionTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@unique([customerId, planId]) // Prevent duplicate subscriptions to same plan
  @@index([customerId])
  @@index([planId])
  @@index([status])
  @@index([nextBillingDate])
}

enum CustomerSubscriptionStatus {
  PENDING // Awaiting payment
  ACTIVE
  PAST_DUE // Payment failed, grace period
  CANCELLED
  EXPIRED
  SUSPENDED
}

model SubscriptionTransaction {
  id             String               @id @default(cuid())
  subscriptionId String
  subscription   CustomerSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  amount   Decimal
  currency String            @default("USD")
  status   TransactionStatus @default(PENDING)
  type     TransactionType

  // Payment details
  paymentMethodId  String?
  transactionId    String? @unique
  blockchainTxHash String? @unique

  // Processing
  processedAt   DateTime?
  failureReason String?

  // Metadata
  billingCycle BillingCycle?
  periodStart  DateTime?
  periodEnd    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([subscriptionId])
  @@index([status])
  @@index([type])
  @@index([transactionId])
  @@index([blockchainTxHash])
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum TransactionType {
  SUBSCRIPTION_PAYMENT
  RENEWAL
  UPGRADE
  DOWNGRADE
  REFUND
  TRIAL_CONVERSION
}

// Future Web3 extensions (placeholders)
model Web3SubscriptionContract {
  id     String           @id @default(cuid())
  planId String           @unique
  plan   SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  contractAddress String @unique
  network         String // e.g., "polygon", "ethereum"
  abi             Json

  isActive   Boolean   @default(false)
  deployedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([planId])
  @@index([network])
  @@index([isActive])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  CUSTOMER
  RESTAURANT_OWNER
  RESTAURANT_STAFF
  DELIVERY_DRIVER
  VENDOR
}

// ============================================================================
// COMMERCE & ECOSYSTEM MODELS
// ============================================================================

model Restaurant {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  description String?
  address     String
  phone       String?
  email       String?
  latitude    Float?
  longitude   Float?
  isActive    Boolean @default(true)

  menuItems      MenuItem[]
  orders         Order[]
  staff          StaffProfile[]
  shifts         Shift[]
  inventory      Inventory[]
  purchaseOrders PurchaseOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model MenuItem {
  id           String     @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  name            String
  description     String?
  price           Decimal
  category        String
  image           String?
  isAvailable     Boolean @default(true)
  preparationTime Int? // in minutes

  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
}

model Order {
  id           String     @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  customerId String?
  customer   User?   @relation("CustomerOrders", fields: [customerId], references: [id])

  status         OrderStatus @default(PENDING)
  totalAmount    Decimal
  taxAmount      Decimal     @default(0)
  serviceFee     Decimal     @default(0)
  discountAmount Decimal     @default(0)

  paymentStatus PaymentStatus @default(UNPAID)
  paymentMethod String? // CASH, CARD, CRYPTO, WALLET

  items    OrderItem[]
  feedback Feedback?
  delivery Delivery?

  loyaltyPointsEarned Int @default(0)
  loyaltyPointsUsed   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
  @@index([customerId])
  @@index([status])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  menuItemId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  quantity   Int
  unitPrice  Decimal
  totalPrice Decimal
  notes      String?

  @@index([orderId])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  UNPAID
  PAID
  PARTIALLY_PAID
  REFUNDED
  FAILED
}

// ============================================================================
// LOYALTY & REWARDS PROTOCOL
// ============================================================================

model CustomerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  loyaltyPoints Int     @default(0)
  totalSpent    Decimal @default(0)
  orderCount    Int     @default(0)

  tierId String?
  tier   LoyaltyTier? @relation(fields: [tierId], references: [id])

  referralCode String?           @unique
  referredById String?
  referredBy   CustomerProfile?  @relation("Referrals", fields: [referredById], references: [id])
  referrals    CustomerProfile[] @relation("Referrals")

  pointHistory LoyaltyTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoyaltyTier {
  id              String   @id @default(cuid())
  name            String // Bronze, Silver, Gold, Platinum, Diamond
  minSpending     Decimal // Minimum lifetime spending to reach
  pointMultiplier Float    @default(1.0)
  perks           String[] // ["Priority Support", "Zero Fees", "Exclusive Drops"]

  customers CustomerProfile[]
}

model LoyaltyTransaction {
  id        String          @id @default(cuid())
  profileId String
  profile   CustomerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  amount Int // Positive for earn, negative for spend
  reason String // "Order #123", "Referral Bonus", "Birthday Gift"
  type   LoyaltyTxType

  createdAt DateTime @default(now())
}

enum LoyaltyTxType {
  EARN
  REDEEM
  EXPIRED
  ADJUSTMENT
}

model Feedback {
  id      String @id @default(cuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  rating         Int // 1 to 5
  comment        String?
  sentimentScore Float? // Generated by AI (-1.0 to 1.0)

  createdAt DateTime @default(now())
}

// ============================================================================
// STAFF & SHIFTS
// ============================================================================

model StaffProfile {
  id           String     @id @default(cuid())
  userId       String     @unique
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  role         String // MANAGER, CASHIER, CHEF, WAITER
}

model Shift {
  id           String     @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  userId       String
  openedAt     DateTime   @default(now())
  closedAt     DateTime?
}

// ============================================================================
// SUPPLY CHAIN & INVENTORY (Task B)
// ============================================================================

model Supplier {
  id       String  @id @default(cuid())
  name     String
  email    String  @unique
  phone    String?
  address  String?
  category String? // "Produce", "Meat", "Packaging"
  isActive Boolean @default(true)

  inventoryItems Inventory[]
  purchaseOrders PurchaseOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Inventory {
  id           String     @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  name         String
  sku          String?
  unit         String // "kg", "pcs", "liters"
  quantity     Decimal @default(0)
  reorderLevel Decimal @default(10) // Threshold for smart restocking
  unitCost     Decimal @default(0)

  movements InventoryMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
  @@index([supplierId])
}

model InventoryMovement {
  id          String    @id @default(cuid())
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  type        MovementType
  quantity    Decimal
  reason      String?
  referenceId String? // Order ID or PO ID

  createdAt DateTime @default(now())
}

model PurchaseOrder {
  id           String     @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  status    POStatus @default(DRAFT)
  totalCost Decimal
  items     Json // Array of { itemId, quantity, cost }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
  @@index([supplierId])
}

enum MovementType {
  IN // Restock
  OUT // Sold/Used
  WASTE // Spoiled
  ADJUSTMENT // Audit
}

enum POStatus {
  DRAFT
  SENT
  ACCEPTED
  SHIPPED
  DELIVERED
  CANCELLED
}

// ============================================================================
// DELIVERY & LOGISTICS (Task C)
// ============================================================================

model Delivery {
  id      String @id @default(cuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  driverId String?
  driver   User?   @relation("DriverDeliveries", fields: [driverId], references: [id])

  status       DeliveryStatus @default(PENDING)
  pickupTime   DateTime?
  deliveryTime DateTime?

  pickupAddress  String
  dropoffAddress String
  courierNote    String?

  trackingUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
  @@index([status])
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  FAILED
  CANCELLED
}

// ============================================================================
// AI & NEURAL MESH PERSISTENCE
// ============================================================================

model AIMemory {
  id              String   @id @default(cuid())
  requestId       String   @unique
  context         Json
  inputData       Json
  result          Json
  outcome         String? // SUCCESS, FAILURE, DISPUTED
  inventorySignal String? // STABLE, RESTOCK_REQUIRED
  timestamp       DateTime @default(now())

  @@index([requestId])
  @@index([timestamp])
}

model AIModelWeight {
  id        String   @id @default(cuid())
  modelName String   @unique
  weights   Json
  updatedAt DateTime @updatedAt

  @@index([modelName])
}

// ============================================================================
// ADVANCED ECOSYSTEM LOYALTY & GAMIFICATION MODELS
// ============================================================================

// ============================================================================
// NEURAL LOYALTY ENGINE MODELS
// ============================================================================

model NeuralLoyaltyProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Core Metrics
  totalPoints     Decimal @default(0)
  availablePoints Decimal @default(0)
  lifetimeEarned  Decimal @default(0)
  lifetimeSpent   Decimal @default(0)

  // AI-Personalized Scoring
  neuralScore       Float   @default(0) // 0-1 AI confidence score
  behaviorCluster   String? // AI-assigned behavior pattern
  rewardSensitivity Float   @default(0.5) // How responsive to rewards

  // Tier System
  currentTierId String?
  currentTier   NeuralLoyaltyTier? @relation(fields: [currentTierId], references: [id])
  tierProgress  Float              @default(0) // 0-1 progress to next tier

  // Activity Tracking
  lastActivityAt DateTime?
  streakCount    Int       @default(0)
  maxStreak      Int       @default(0)

  // Chaos Event Bonuses
  chaosMultiplier Float     @default(1.0)
  lastChaosEvent  DateTime?

  // Relations
  transactions      NeuralLoyaltyTransaction[]
  achievements      NeuralUserAchievement[]
  challenges        NeuralUserChallenge[]
  rewards           NeuralUserReward[]
  chaosParticipants NeuralChaosParticipant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([neuralScore])
  @@index([currentTierId])
}

model NeuralLoyaltyTier {
  id          String  @id @default(cuid())
  name        String  @unique // Bronze, Silver, Gold, Platinum, Diamond
  displayName String
  description String?
  color       String  @default("#6B7280") // Hex color

  // Requirements
  minLifetimeSpent Decimal @default(0)
  minOrderCount    Int     @default(0)
  minStreakDays    Int     @default(0)

  // Benefits
  pointMultiplier Float @default(1.0)
  bonusMultiplier Float @default(1.0)
  priorityLevel   Int   @default(0) // Queue priority

  // Limits
  maxMonthlyOrders Int?
  maxMonthlySpend  Decimal?

  // Status
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  // Relations
  profiles NeuralLoyaltyProfile[]
  benefits NeuralLoyaltyBenefit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([sortOrder])
}

model NeuralLoyaltyBenefit {
  id     String            @id @default(cuid())
  tierId String
  tier   NeuralLoyaltyTier @relation(fields: [tierId], references: [id], onDelete: Cascade)

  type        NeuralBenefitType
  title       String
  description String?
  value       Json? // Flexible value storage

  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tierId])
  @@index([type])
}

enum NeuralBenefitType {
  DISCOUNT_PERCENTAGE
  FREE_DELIVERY
  PRIORITY_SUPPORT
  EARLY_ACCESS
  EXCLUSIVE_ITEM
  BONUS_POINTS_MULTIPLIER
  SPECIAL_BADGE
  VIP_INVITATIONS
  CUSTOM
}

model NeuralLoyaltyTransaction {
  id        String               @id @default(cuid())
  profileId String
  profile   NeuralLoyaltyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  amount      Decimal
  type        NeuralLoyaltyTxType
  reason      String
  description String?

  // AI Context
  aiConfidence    Float? // How confident AI was in this reward
  behaviorFactors Json? // AI analysis of user behavior
  chaosEventBonus Boolean @default(false)

  // Source tracking
  orderId       String?
  challengeId   String?
  achievementId String?
  rewardId      String?

  // Metadata
  metadata  Json?
  expiresAt DateTime?

  createdAt DateTime @default(now())

  @@index([profileId])
  @@index([type])
  @@index([createdAt])
  @@index([expiresAt])
}

enum NeuralLoyaltyTxType {
  EARN_ORDER // From order completion
  EARN_REFERRAL // From referrals
  EARN_STREAK // From activity streaks
  EARN_ACHIEVEMENT // From achievements
  EARN_CHAOS // From chaos event participation
  EARN_AI_BONUS // AI-generated personalized bonus

  SPEND_REWARD // Redeemed for reward
  EXPIRE // Points expired
  ADJUSTMENT // Manual adjustment
  TRANSFER // Points transferred to another user
}

// ============================================================================
// INSTITUTIONAL REPUTATION SCORES MODELS
// ============================================================================

model InstitutionalReputation {
  id         String               @id @default(cuid())
  entityId   String // Restaurant or Supplier ID
  entityType ReputationEntityType // RESTAURANT or SUPPLIER

  // On-Chain Data
  contractAddress String? // Smart contract address
  tokenId         String? // NFT token ID for reputation
  chainId         Int     @default(137) // Polygon mainnet

  // Reputation Metrics
  overallScore Float @default(0) // 0-100 composite score
  trustScore   Float @default(0) // Based on delivery/payment reliability
  qualityScore Float @default(0) // Based on ratings and feedback
  volumeScore  Float @default(0) // Based on transaction volume

  // Performance History
  totalOrders      Int    @default(0)
  successfulOrders Int    @default(0)
  averageRating    Float  @default(0)
  responseTime     Float? // Average response time in minutes

  // Negotiation Priority
  negotiationPriority Float   @default(0) // 0-1 affects contract terms
  preferredPartner    Boolean @default(false)

  // Risk Assessment
  riskLevel   ReputationRiskLevel @default(MEDIUM)
  lastAuditAt DateTime?
  nextAuditAt DateTime?

  // Relations
  reviews      InstitutionalReview[]
  achievements InstitutionalAchievement[]
  incidents    ReputationIncident[]

  // Metadata
  verifiedAt    DateTime?
  lastUpdatedAt DateTime  @default(now())
  createdAt     DateTime  @default(now())

  @@unique([entityId, entityType])
  @@index([entityType])
  @@index([overallScore])
  @@index([negotiationPriority])
  @@index([riskLevel])
}

enum ReputationEntityType {
  RESTAURANT
  SUPPLIER
  DELIVERY_PARTNER
  MARKETPLACE_SELLER
}

enum ReputationRiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model InstitutionalReview {
  id           String                  @id @default(cuid())
  reputationId String
  reputation   InstitutionalReputation @relation(fields: [reputationId], references: [id], onDelete: Cascade)

  reviewerId   String // User who left review
  reviewerType ReputationEntityType
  rating       Int // 1-5 stars
  comment      String?

  // Review Categories
  qualityRating       Int? // Product/service quality
  timelinessRating    Int? // Delivery/on-time performance
  communicationRating Int? // Responsiveness

  // AI Analysis
  sentimentScore    Float? // -1 to 1 (negative to positive)
  aiVerified        Boolean @default(false)
  authenticityScore Float? // How likely this review is genuine

  // Transaction Context
  orderId       String?
  transactionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reputationId])
  @@index([rating])
  @@index([createdAt])
}

model InstitutionalAchievement {
  id           String                  @id @default(cuid())
  reputationId String
  reputation   InstitutionalReputation @relation(fields: [reputationId], references: [id], onDelete: Cascade)

  type        AchievementType
  title       String
  description String
  badgeIcon   String? // Icon/emoji for display

  earnedAt  DateTime  @default(now())
  expiresAt DateTime? // Some achievements expire

  @@index([reputationId])
  @@index([type])
  @@index([earnedAt])
}

enum AchievementType {
  TOP_RATED // Consistently high ratings
  HIGH_VOLUME // Large transaction volume
  PERFECT_STREAK // No failed deliveries/orders
  FAST_RESPONDER // Quick response times
  LOYAL_CUSTOMER // Long-term partner
  INNOVATION_LEADER // First to adopt new features
  QUALITY_CHAMPION // Highest quality scores
  RELIABILITY_MASTER // Best uptime/reliability
}

model ReputationIncident {
  id           String                  @id @default(cuid())
  reputationId String
  reputation   InstitutionalReputation @relation(fields: [reputationId], references: [id], onDelete: Cascade)

  type        IncidentType
  severity    IncidentSeverity
  description String
  impact      Float // Impact on reputation score (0-1)

  // Resolution
  resolvedAt         DateTime?
  resolution         String?
  preventiveMeasures String?

  // Evidence
  evidence  Json? // Links to orders, messages, etc.
  witnesses String[] // Other entities that confirmed incident

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reputationId])
  @@index([type])
  @@index([severity])
  @@index([createdAt])
}

enum IncidentType {
  LATE_DELIVERY
  ORDER_CANCELLATION
  QUALITY_ISSUE
  COMMUNICATION_FAILURE
  PAYMENT_DISPUTE
  COMPLIANCE_VIOLATION
  SYSTEM_OUTAGE
  FRAUD_ATTEMPT
}

enum IncidentSeverity {
  LOW // Minor inconvenience, no lasting impact
  MEDIUM // Some impact on operations
  HIGH // Significant business impact
  CRITICAL // Major damage to reputation/trust
}

// ============================================================================
// GAMIFIED GOVERNANCE MODELS
// ============================================================================

model GovernanceProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Protocol Merit Tokens
  totalMerit     Decimal @default(0)
  availableMerit Decimal @default(0)
  stakedMerit    Decimal @default(0)

  // Participation Metrics
  proposalsCreated    Int @default(0)
  votesCast           Int @default(0)
  successfulProposals Int @default(0)

  // Activity Streaks
  votingStreak    Int       @default(0)
  maxVotingStreak Int       @default(0)
  lastVoteAt      DateTime?

  // Reputation & Influence
  governanceLevel Int     @default(1) // 1-5 influence levels
  influenceScore  Float   @default(0) // 0-1 voting weight modifier
  reputationBadge String? // "Pioneer", "Guardian", "Architect", etc.

  // Special Roles
  isDelegate     Boolean   @default(false)
  delegatedVotes Decimal   @default(0)
  delegateSince  DateTime?

  // Rewards & Bonuses
  meritEarned  Decimal   @default(0)
  meritSpent   Decimal   @default(0)
  lastRewardAt DateTime?

  // Relations
  votes               GovernanceVote[]
  delegationsGiven    GovernanceDelegation[] @relation("delegator")
  delegationsReceived GovernanceDelegation[] @relation("delegate")

  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  MeritTransaction MeritTransaction[]

  @@index([userId])
  @@index([governanceLevel])
  @@index([influenceScore])
  @@index([isDelegate])
}

model GovernanceDelegation {
  id          String            @id @default(cuid())
  delegatorId String
  delegator   GovernanceProfile @relation("delegator", fields: [delegatorId], references: [id], onDelete: Cascade)

  delegateId String
  delegate   GovernanceProfile @relation("delegate", fields: [delegateId], references: [id], onDelete: Cascade)

  // Delegation Details
  votingPower    Decimal // Amount of voting power delegated
  delegationType DelegationType @default(TEMPORARY)

  // Duration
  startsAt  DateTime  @default(now())
  expiresAt DateTime?
  revokedAt DateTime?

  // Conditions (future feature)
  conditions Json? // Smart contract conditions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([delegatorId, delegateId])
  @@index([delegatorId])
  @@index([delegateId])
  @@index([expiresAt])
}

enum DelegationType {
  PERMANENT // Until revoked
  TEMPORARY // Time-limited
  CONDITIONAL // Based on conditions
  LIMITED // Limited voting power
}

model MeritTransaction {
  id        String            @id @default(cuid())
  profileId String
  profile   GovernanceProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  amount      Decimal
  type        MeritTxType
  reason      String
  description String?

  // Source tracking
  proposalId  String?
  voteId      String?
  challengeId String?

  // AI Context
  aiBonus      Boolean @default(false)
  aiMultiplier Float   @default(1.0)

  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])
  userId    String?

  @@index([profileId])
  @@index([type])
  @@index([createdAt])
}

enum MeritTxType {
  EARN_PROPOSAL // Created successful proposal
  EARN_VOTE // Participated in voting
  EARN_STREAK // Consistent participation
  EARN_DELEGATION // Received delegation
  EARN_ACHIEVEMENT // Governance achievements

  SPEND_STAKE // Staked for influence
  SPEND_REWARD // Redeemed for rewards
  TRANSFER // Transferred to another user
  EXPIRE // Merit tokens expired
}

// ============================================================================
// ACHIEVEMENT & CHALLENGE SYSTEM
// ============================================================================

model Achievement {
  id          String              @id @default(cuid())
  name        String              @unique
  title       String
  description String
  category    AchievementCategory

  // Requirements
  requirements Json // Flexible requirement structure
  difficulty   AchievementDifficulty @default(MEDIUM)

  // Rewards
  meritReward  Decimal @default(0)
  pointReward  Decimal @default(0)
  specialBadge String?

  // Rarity & Visibility
  rarity   AchievementRarity @default(COMMON)
  isActive Boolean           @default(true)
  isSecret Boolean           @default(false)

  // Relations
  userAchievements NeuralUserAchievement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([difficulty])
  @@index([rarity])
  @@index([isActive])
}

enum AchievementCategory {
  LOYALTY
  GOVERNANCE
  PERFORMANCE
  SOCIAL
  SPECIAL
}

enum AchievementDifficulty {
  EASY
  MEDIUM
  HARD
  EPIC
  LEGENDARY
}

enum AchievementRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
  MYTHIC
}

model NeuralUserAchievement {
  id            String      @id @default(cuid())
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  userId           String
  loyaltyProfileId String
  loyaltyProfile   NeuralLoyaltyProfile @relation(fields: [loyaltyProfileId], references: [id], onDelete: Cascade)

  // Progress & Status
  progress    Float     @default(0) // 0-1 completion progress
  isCompleted Boolean   @default(false)
  completedAt DateTime?

  // Rewards Claimed
  rewardsClaimed Boolean   @default(false)
  claimedAt      DateTime?

  // Metadata
  progressData   Json? // Current progress details
  completionData Json? // Data when completed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id])

  @@unique([achievementId, userId])
  @@index([userId])
  @@index([isCompleted])
  @@index([completedAt])
}

// ============================================================================
// CHALLENGE & QUEST SYSTEM
// ============================================================================

model Challenge {
  id          String            @id @default(cuid())
  name        String            @unique
  title       String
  description String
  category    ChallengeCategory

  // Challenge Details
  type            ChallengeType
  duration        ChallengeDuration?
  maxParticipants Int?

  // Requirements & Objectives
  objectives   Json // Array of objectives to complete
  requirements Json? // Prerequisites to join

  // Rewards
  meritReward     Decimal @default(0)
  pointReward     Decimal @default(0)
  bonusMultiplier Float   @default(1.0)

  // Timing
  startsAt       DateTime?
  endsAt         DateTime?
  isRecurring    Boolean   @default(false)
  recurrenceRule String? // Cron-like expression

  // Status
  status   ChallengeStatus @default(DRAFT)
  isActive Boolean         @default(true)

  // Relations
  participants NeuralUserChallenge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([type])
  @@index([status])
  @@index([startsAt])
  @@index([endsAt])
}

enum ChallengeCategory {
  LOYALTY_BUILDING
  GOVERNANCE_PARTICIPATION
  PERFORMANCE_IMPROVEMENT
  SOCIAL_ENGAGEMENT
  SEASONAL_EVENT
  CHAOS_EVENT
}

enum ChallengeType {
  INDIVIDUAL // Single user completion
  TEAM // Group collaboration
  COMPETITIVE // Leaderboard competition
  COLLABORATIVE // Community wide goal
  STREAK // Daily/weekly consistency
}

enum ChallengeDuration {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  CUSTOM
}

enum ChallengeStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

model NeuralUserChallenge {
  id          String    @id @default(cuid())
  challengeId String
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  userId           String
  loyaltyProfileId String
  loyaltyProfile   NeuralLoyaltyProfile @relation(fields: [loyaltyProfileId], references: [id], onDelete: Cascade)

  // Participation
  joinedAt DateTime            @default(now())
  status   UserChallengeStatus @default(ACTIVE)

  // Progress
  progress           Float @default(0) // 0-1 overall completion
  objectivesProgress Json // Progress on individual objectives
  score              Int   @default(0) // Points earned in challenge

  // Results
  completedAt    DateTime?
  finalRank      Int?
  rewardsClaimed Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id])

  @@unique([challengeId, userId])
  @@index([userId])
  @@index([status])
  @@index([completedAt])
}

enum UserChallengeStatus {
  ACTIVE
  COMPLETED
  ABANDONED
  DISQUALIFIED
}

// ============================================================================
// REWARD SYSTEM
// ============================================================================

model Reward {
  id          String         @id @default(cuid())
  name        String         @unique
  title       String
  description String
  category    RewardCategory

  // Reward Details
  type  RewardType
  value Json // Flexible value structure
  cost  Decimal // Points/merit cost

  // Availability
  isActive     Boolean @default(true)
  stockLimit   Int? // Limited availability
  currentStock Int     @default(-1) // -1 = unlimited

  // Targeting
  targetAudience RewardAudience @default(ALL)
  requirements   Json? // Eligibility requirements

  // Relations
  userRewards NeuralUserReward[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([type])
  @@index([isActive])
  @@index([targetAudience])
}

enum RewardCategory {
  DISCOUNT
  FREE_ITEM
  EXCLUSIVE_ACCESS
  SPECIAL_EXPERIENCE
  DIGITAL_BADGE
  PHYSICAL_ITEM
  DONATION_MATCH
  CUSTOM
}

enum RewardType {
  PERCENTAGE_DISCOUNT
  FIXED_AMOUNT_DISCOUNT
  FREE_DELIVERY
  FREE_ITEM
  EARLY_ACCESS
  VIP_TICKET
  BADGE
  CERTIFICATE
  PHYSICAL_PRODUCT
  EXPERIENCE
}

enum RewardAudience {
  ALL
  PREMIUM
  TOP_TIER
  NEW_USERS
  LONG_TERM
  HIGH_SPENDERS
  CUSTOM
}

model NeuralUserReward {
  id       String @id @default(cuid())
  rewardId String
  reward   Reward @relation(fields: [rewardId], references: [id], onDelete: Cascade)

  userId           String
  loyaltyProfileId String
  loyaltyProfile   NeuralLoyaltyProfile @relation(fields: [loyaltyProfileId], references: [id], onDelete: Cascade)

  // Redemption
  redeemedAt DateTime @default(now())
  costPaid   Decimal

  // Fulfillment
  status          RewardStatus @default(PENDING)
  fulfillmentData Json?
  fulfilledAt     DateTime?
  expiresAt       DateTime?

  // Usage
  usedAt    DateTime?
  usageData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rewardId])
  @@index([userId])
  @@index([status])
  @@index([redeemedAt])
}

enum RewardStatus {
  PENDING
  PROCESSING
  FULFILLED
  EXPIRED
  CANCELLED
  USED
}

// ============================================================================
// CHAOS EVENT SYSTEM (AI-Powered Special Events)
// ============================================================================

model ChaosEvent {
  id          String @id @default(cuid())
  name        String @unique
  title       String
  description String

  // Event Configuration
  type             ChaosEventType
  triggerCondition Json // AI conditions to trigger event
  duration         Int // Duration in hours

  // AI Parameters
  intensity        Float         @default(1.0) // 0-1 event intensity
  targetAudience   ChaosAudience
  participantLimit Int?

  // Rewards Multipliers
  pointMultiplier Float @default(2.0)
  meritMultiplier Float @default(1.5)
  streakBonus     Float @default(0.5)

  // Timing
  scheduledAt DateTime?
  startedAt   DateTime?
  endedAt     DateTime?

  // Status
  status ChaosEventStatus @default(DRAFT)

  // Relations
  participants NeuralChaosParticipant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([scheduledAt])
  @@index([startedAt])
}

enum ChaosEventType {
  HIGH_DEMAND // Peak hours with extra orders
  WEATHER_DISRUPTION // Weather affecting deliveries
  SYSTEM_STRESS // High load periods
  MARKET_VOLATILITY // Price fluctuations requiring quick adaptation
  SUPPLY_SHORTAGE // Limited ingredient availability
  EMERGENCY_RESPONSE // Real-world emergency requiring system adaptation
  AI_CHALLENGE // AI-generated business puzzle
  SOCIAL_CHALLENGE // Community participation challenge
}

enum ChaosAudience {
  DRIVERS // Delivery drivers
  RESTAURANTS // Restaurant staff
  CUSTOMERS // End customers
  SUPPLIERS // Supply chain partners
  ALL // Everyone in ecosystem
  RANDOM // Random selection
}

enum ChaosEventStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELLED
}

model NeuralChaosParticipant {
  id      String     @id @default(cuid())
  eventId String
  event   ChaosEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  userId           String
  loyaltyProfileId String
  loyaltyProfile   NeuralLoyaltyProfile @relation(fields: [loyaltyProfileId], references: [id], onDelete: Cascade)

  // Participation
  joinedAt DateTime             @default(now())
  role     ChaosParticipantRole @default(PARTICIPANT)

  // Performance
  participationScore Float   @default(0) // 0-1 performance metric
  tasksCompleted     Int     @default(0)
  bonusEarned        Decimal @default(0)

  // Results
  finalRank    Int?
  achievements Json? // Special achievements during event

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([role])
}

enum ChaosParticipantRole {
  PARTICIPANT
  LEADER
  COORDINATOR
  SPECIALIST
}

// ============================================================================
// ADAPTIVE JURY & DISPUTE RESOLUTION
// ============================================================================

model JuryCase {
  id        String     @id @default(cuid())
  disputeId String     @unique
  status    JuryStatus @default(VOTING_OPEN)
  deadline  DateTime

  votesForBuyer  Int @default(0)
  votesForSeller Int @default(0)

  jurors String[] // User IDs of assigned jurors
  votes  JuryVote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([deadline])
}

model JuryVote {
  id     String @id @default(cuid())
  caseId String
  case   JuryCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  jurorId String
  vote    VoteChoice

  createdAt DateTime @default(now())

  @@unique([caseId, jurorId])
  @@index([caseId])
  @@index([jurorId])
}

enum JuryStatus {
  VOTING_OPEN
  RESOLVED
  CANCELLED
  EXPIRED
}

enum VoteChoice {
  BUYER
  SELLER
}
